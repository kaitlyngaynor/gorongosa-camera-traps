---
title: "Occupancy matrix wrangling"
output: html_document
editor_options: 
  chunk_output_type: console
---

The goal here is to be able to easily generate summarized occupancy records for different time periods in the necessary format for analysis using Lindsey's code.

12/11/18 - see also the "Occupancy_matrix_wrangling_monthly_for_loop" where I re-coded this to allow for the calculation of matrices for multiple time periods simultaneously using a for loop.

Here, I bring in the master file with all of the 0 and 1 records (non-detection and detection, plus NA for periods of camera inoperability). The columns correspond to dates, and the rows corespond to species-camera. I believe I manually created this file by combining each species matrix generated by camtrapR, but I may have done it within camtrapR? I forget, and don't have the code, unfortunately. 
```{r setup, message = F}
library(tidyverse)
library(sjmisc)
library(here)

matrix.all <- read.csv(here::here("data", "raw-data", "All_species_by_date_year1and2_082919.csv"), header=T)
#matrix.all <- read.csv("Data/Raw Data/All_species_by_date_062316_090417.csv", header=T)

summary(matrix.all$Species) # look at output and confirm that there are 60 rows per species (one for each camera). You can also see what species are included. This is all of them, including birds and human.

summary(matrix.all$Camera) # look at output and confirm that there are 38 rows per camera (one for each species)

names(matrix.all) # look at column names - tells you the date range (it's 6/23/16 through 9/15/18, though not all cameras are operating for that entire period)
```

The detection output that we want has one column per species, and one row per camera. The cell will contain the number of columns (days) with a value of 1 (detections) for the given time period.

First, take a subset of the original spreadsheet for the dates of interest by selecting columns between the start and end dates that you want.

(In retrospect, should have done this with a loop; now if you want to loop you have to reset the dates manually every time, ugh, stupid Kaitlyn)
```{r select certain dates}
#start.date <- "X7.1.16"  # change the dates to the dates you want!
#end.date <- "X7.31.16"

## Early Dry, Late Dry, Wet Seasons (following Bouley et al. 2018 - each of these seasons is 4 months long)

## early dry 2016 (Apr - missing, May - missing, Jun - mostly missing, Jul)
# start.date <- "X6.24.16"
# end.date <- "X7.31.16"

## late dry 2016 (Aug, Sep, Oct, Nov)
# start.date <- "X8.1.16"
# end.date <- "X11.30.16"

## wet 2016-17 (Dec, Jan, Feb, Mar)
# start.date <- "X12.1.16"
# end.date <- "X3.31.17"

## early dry 2017 (Apr, May, Jun, Jul)
# start.date <- "X4.1.17" 
# end.date <- "X7.31.17"

## 3-month peak wet and peak dry seasons, based on Stalmans rainfall data

## dry 2016 - July, August, September (11, 0.2, and 2.2 mm rain respectively)
# start.date <- "X7.1.16"
# end.date <- "X9.30.16"

## wet 2017 - January, February, March (122.8, 63.4, 136.6 mm rain respectively; excluded Dec because greenup didn't start til the end of the month)
# start.date <- "X1.1.17"
# end.date <- "X3.31.17"

## wet 2017 alternate - December, January, February, March - including December because there just aren't enough cameras with solid detection histories from Jan-March (due to tall grass)
#start.date <- "X12.1.16"
#end.date <- "X3.31.17"

## dry 2017 - July, August, September
#start.date <- "X7.1.17"
#end.date <- "X9.30.17"

## wet 2018 3mo - January, February, March
#start.date <- "X1.1.18"
#end.date <- "X3.31.18"

## wet 2018 4mo - December, January, February, March
#start.date <- "X12.1.17"
#end.date <- "X3.31.18"

## dry 2018 - only 6 cameras working in this period
##start.date <- "X7.1.18"
##end.date <- "X9.15.18"

## aerial count - the exact dates of the aerial count (10/18/16 - 10/31/16), two week period
#start.date <- "X10.18.16"
#end.date <- "X10.31.16"

## aerial count +/- two weeks - a six-week window around the aerial count (1.5 months)
#start.date <- "X10.4.16"
#end.date <- "X11.14.16"

## aerial count +/- four weeks - a ten-week window around the aerial count (2.5 months)
#start.date <- "X9.20.16"
#end.date <- "X11.28.16"

## aerial count 3 months in 2016
#start.date <- "X9.1.16"
#end.date <- "X11.30.16"

## aerial count equivalent 3 months in 2017
start.date <- "X9.1.17"
end.date <- "X11.30.17"
```

We want a spreadsheet of camera operation. That will have one row per camera, with just one additional column for the number of sampling periods (days). This will correspond to the number of columns in the original spreadsheet for which there is a 0 or 1 (rather than an NA).

We also want to calculate the total number of sampling periods with detections (value of 1). 

```{r camera operation spreadsheet}
matrix.subset <- dplyr::select(matrix.all, Camera, Species, start.date:end.date) # selects columns within specified dates

zeroes <- row_count(matrix.subset, start.date:end.date, count = 0, append = FALSE) # count the columns with zeroes
ones <- row_count(matrix.subset, start.date:end.date, count = 1, append = FALSE) # count the columns with ones

Detections <- ones # detections are just the ones
names(Detections) <- "Detections"
Operation <- zeroes + ones # add zeroes and ones together to figure out how many days it operated for
names(Operation) <- "Operation"

# combine  count dataframes with the matrix subset
matrix.subset <- cbind(matrix.subset, Operation) 
matrix.subset <- cbind(matrix.subset, Detections) 

# change "Camera" name to "StudySite"
names(matrix.subset) <- c("StudySite", names(matrix.subset)[2:ncol(matrix.subset)])

# get just operation and detection
matrix.subset <- dplyr::select(matrix.subset, StudySite, Species, Operation, Detections)

matrix.subset.test <- matrix.subset[matrix.subset$StudySite == "K08",]

# remove any cameras operating for <10 days (set Detections = 0, Operation = 0)
for (i in 1:nrow(matrix.subset)) {
  if (matrix.subset$Operation[i] < 10) {
    matrix.subset$Detections[i] <- 0
    matrix.subset$Operation[i] <- 0
  }
}

# for operation matrix, get rid of the detections and species, just select Camera, Operation
matrix.operation <- dplyr::select(matrix.subset, StudySite, Operation) 

# extract only the top 60 rows, since they are duplicated 42 times (one for each species)
matrix.operation <- matrix.operation[1:60,] 

matrix.detections <- dplyr::select(matrix.subset, StudySite, Species, Detections) # get rid of the day detections, just select Camera, Species, Detections
head(matrix.detections) # take a look at the head

# spread the data so there is one column per species and one row per camera
matrix.detections <- spread(matrix.detections, key = Species, value = Detections)
head(matrix.detections)

# change date names for export
start.date.2 <- gsub("[.]", "_", start.date)
start.date.2 <- gsub("X", "", start.date.2)
end.date.2 <- gsub("[.]", "_", end.date)
end.date.2 <- gsub("X", "", end.date.2)

# export operation matrix
write.csv(matrix.operation, file = paste("Data/Cleaned_occupancy_records/Camoperation_", start.date.2, "_", end.date.2, ".csv", collapse = "", sep = ""),row.names=F)

# export detection matrix
write.csv(matrix.detections, file = paste("Data/Cleaned_occupancy_records/Detections_", start.date.2, "_", end.date.2, ".csv", collapse = "", sep = ""),row.names=F)
```



